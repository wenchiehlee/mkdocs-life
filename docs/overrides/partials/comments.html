{% set comments_cfg = config.extra.comments | default({}) %}
{% set disqus_cfg = config.extra.disqus | default({}) %}
{% set disqus_shortname = (
  comments_cfg.disqus.shortname
  if comments_cfg and comments_cfg.disqus
  else disqus_cfg.shortname
  if disqus_cfg is mapping
  else disqus_cfg
) %}

{% if page.meta.comments and disqus_shortname %}
  <h2 id="__comments">{{ lang.t("meta.comments") }}</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "{{ page.canonical_url | d(config.site_url ~ page.url, true) }}"
      this.page.identifier = "{{ page.url }}"
    }

    (function() {
      var shortname = "{{ disqus_shortname }}"

      if (window.DISQUS) {
        window.DISQUS.reset({
          reload: true,
          config: disqus_config
        })
        return
      }

      var d = document, s = d.createElement("script")
      s.src = "https://" + shortname + ".disqus.com/embed.js"
      s.setAttribute("data-timestamp", +new Date())
      ;(d.head || d.body).appendChild(s)
    })()
  </script>
{% endif %}
